
#include "gmp.h"
#include <dlfcn.h>
#include <string.h>
#include <stdio.h>

typedef void (mpz_init_func) (mpz_t x);
typedef int (mpz_set_str_func) (MP_INT *integer, char *initial_value, int base);
typedef char * (mpz_get_str_func) (char *string, int base, MP_INT *integer);
typedef void (mpz_add_func) (MP_INT *sum, MP_INT *addend1, MP_INT *addend2);

int main() {
    void* lib_handle = (void *)dlopen(".libs/libgmp.so", RTLD_LAZY); 
    mpz_set_str_func* mpz_set_str = dlsym(lib_handle, "__gmpz_set_str");
    mpz_init_func* mpz_init = dlsym(lib_handle, "__gmpz_init");
    mpz_add_func* mpz_add = dlsym(lib_handle, "__gmpz_add");
    mpz_get_str_func* mpz_get_str = dlsym(lib_handle, "__gmpz_get_str");


    char two1087[] =       "1658079259093488585543641880321370579349968074867852233579735924960709341741017881738939463282172923864572541864483323178105313176664420162494573772314529873277070739673631632297712908223227628267436176822048727601659965304215082587079502689477915085543915982949243040172715332527968276743670394950828083309016741815037909270528";
    char two1087minus1[] = "1658079259093488585543641880321370579349968074867852233579735924960709341741017881738939463282172923864572541864483323178105313176664420162494573772314529873277070739673631632297712908223227628267436176822048727601659965304215082587079502689477915085543915982949243040172715332527968276743670394950828083309016741815037909270527";
    char two1088[] = "3316158518186977171087283760642741158699936149735704467159471849921418683482035763477878926564345847729145083728966646356210626353328840324989147544629059746554141479347263264595425816446455256534872353644097455203319930608430165174159005378955830171087831965898486080345430665055936553487340789901656166618033483630075818541056";
    char two1088minus1[] = "3316158518186977171087283760642741158699936149735704467159471849921418683482035763477878926564345847729145083728966646356210626353328840324989147544629059746554141479347263264595425816446455256534872353644097455203319930608430165174159005378955830171087831965898486080345430665055936553487340789901656166618033483630075818541055";
    char* resultstr;

    mpz_t power_of_two;
    mpz_init(power_of_two);
    mpz_set_str(power_of_two, two1087, 10);

    mpz_t power_of_two_m1;
    mpz_init(power_of_two_m1);
    mpz_set_str(power_of_two_m1, two1087minus1, 10);

    mpz_t result;
    mpz_init(result);

    mpz_add(result,power_of_two,power_of_two_m1);
    resultstr = mpz_get_str(NULL, 10, result);
    printf("%s\n", resultstr);

    if (strcmp(resultstr, two1088minus1) != 0) {
	puts("ERROR! 2^1087+2^1087-1 calculated incorrect.");
    } else {
	puts("2^1087+2^1087-1 calculated correct.");
    }

    mpz_add(result,power_of_two,power_of_two);
    resultstr = mpz_get_str(NULL, 10, result);
    printf("%s\n", resultstr);

    if (strcmp(resultstr, two1088) != 0) {
	puts("ERROR! 2^1087+2^1087 calculated incorrect.");
    } else {
	puts("2^1087+2^1087 calculated correct.");
    }
    return 0;
}

